# üìÖ M√≥dulo de Agendamentos (Appointments)

## ‚úÖ Implementa√ß√£o Completa

O m√≥dulo de agendamentos foi implementado seguindo o mesmo padr√£o arquitetural dos outros m√≥dulos da API.

---

## üèóÔ∏è Arquitetura

```
apps/api/src/modules/appointments/
‚îú‚îÄ‚îÄ __tests__/
‚îÇ   ‚îî‚îÄ‚îÄ appointments.schema.test.ts    # Testes unit√°rios dos schemas
‚îú‚îÄ‚îÄ appointments.schema.ts             # Valida√ß√£o Zod e tipos TypeScript
‚îú‚îÄ‚îÄ appointments.repository.ts         # Camada de acesso ao banco (Prisma)
‚îú‚îÄ‚îÄ appointments.service.ts            # Regras de neg√≥cio e valida√ß√µes
‚îú‚îÄ‚îÄ appointments.controller.ts         # Handlers das requisi√ß√µes HTTP
‚îú‚îÄ‚îÄ appointments.routes.ts             # Defini√ß√£o de rotas e Swagger
‚îî‚îÄ‚îÄ index.ts                          # Exporta√ß√µes do m√≥dulo
```

---

## üìã Funcionalidades Implementadas

### **1. CRUD Completo**

#### **POST /api/v1/appointments**

- Criar novo agendamento
- Valida√ß√µes:
  - Hor√°rio n√£o pode estar no passado
  - M√°ximo 3 meses de anteced√™ncia
  - Apenas hor√°rio comercial (8h-18h)
  - N√£o permite fins de semana
  - Verifica conflitos de hor√°rio do profissional
  - Valida exist√™ncia de cliente, profissional e servi√ßo

#### **GET /api/v1/appointments/:id**

- Buscar agendamento espec√≠fico por ID
- Retorna dados completos (cliente, profissional, servi√ßo, categoria)
- Valida√ß√£o de permiss√£o (apenas cliente ou profissional do agendamento)

#### **GET /api/v1/appointments**

- Listar agendamentos com pagina√ß√£o
- Filtros dispon√≠veis:
  - `status`: PENDING, ACCEPTED, REJECTED, COMPLETED
  - `clientId`: Filtrar por cliente
  - `professionalId`: Filtrar por profissional
  - `serviceId`: Filtrar por servi√ßo
  - `dateFrom` / `dateTo`: Intervalo de datas
  - `page` / `limit`: Pagina√ß√£o

#### **PUT /api/v1/appointments/:id**

- Atualizar agendamento existente
- Valida√ß√µes:
  - N√£o permite editar agendamentos conclu√≠dos ou rejeitados
  - Requer m√≠nimo 24h de anteced√™ncia
  - Verifica novos conflitos de hor√°rio

#### **DELETE /api/v1/appointments/:id**

- Cancelar agendamento
- Valida√ß√µes:
  - Apenas agendamentos PENDING podem ser cancelados
  - Requer m√≠nimo 2h de anteced√™ncia

---

### **2. Gest√£o de Status**

#### **PATCH /api/v1/appointments/:id/status**

- Atualizar status do agendamento
- **Apenas profissionais** podem alterar status
- M√°quina de estados:
  ```
  PENDING ‚Üí ACCEPTED | REJECTED
  ACCEPTED ‚Üí COMPLETED | REJECTED
  REJECTED ‚Üí (estado final)
  COMPLETED ‚Üí (estado final)
  ```
- Valida√ß√µes espec√≠ficas:
  - COMPLETED: Apenas se agendamento j√° passou

---

### **3. Verifica√ß√£o de Disponibilidade**

#### **GET /api/v1/appointments/availability**

- Verifica hor√°rios dispon√≠veis para agendamento
- Par√¢metros:
  - `professionalId`: ID do profissional
  - `serviceId`: ID do servi√ßo
  - `date`: Data no formato YYYY-MM-DD
- Retorna:
  - Slots de 30 minutos (8h-18h)
  - Status de cada slot (dispon√≠vel/ocupado)
  - Raz√£o da indisponibilidade

**Exemplo de resposta:**

```json
{
  "success": true,
  "data": {
    "date": "2024-02-15",
    "professionalId": "clx123",
    "serviceId": "clx456",
    "availableSlots": [
      { "time": "08:00", "available": true },
      { "time": "08:30", "available": true },
      { "time": "09:00", "available": false, "reason": "Hor√°rio j√° ocupado" },
      ...
    ]
  }
}
```

---

### **4. Estat√≠sticas**

#### **GET /api/v1/appointments/stats**

- Estat√≠sticas de agendamentos
- Filtros opcionais:
  - `professionalId`: Estat√≠sticas do profissional
  - `clientId`: Estat√≠sticas do cliente
  - `dateFrom` / `dateTo`: Intervalo de datas
- Retorna:
  - Total de agendamentos
  - Contagem por status (pending, accepted, rejected, completed)
  - Taxa de conclus√£o (%)
  - Avalia√ß√£o m√©dia (se houver reviews)

**Exemplo de resposta:**

```json
{
  "success": true,
  "data": {
    "total": 150,
    "pending": 25,
    "accepted": 100,
    "rejected": 15,
    "completed": 85,
    "completionRate": 85.5,
    "averageRating": 4.8
  }
}
```

---

### **5. Endpoints Utilit√°rios**

#### **GET /api/v1/appointments/my**

- Lista todos os agendamentos do usu√°rio logado
- Identifica automaticamente se √© cliente ou profissional

#### **GET /api/v1/appointments/upcoming**

- Lista pr√≥ximos agendamentos (futuros com status PENDING ou ACCEPTED)
- Ordenado por data mais pr√≥xima

#### **GET /api/v1/appointments/history**

- Lista hist√≥rico de agendamentos passados ou conclu√≠dos
- √ötil para exibir agendamentos anteriores

---

## üîí Valida√ß√µes e Regras de Neg√≥cio

### **Valida√ß√µes de Cria√ß√£o:**

- ‚úÖ Hor√°rio n√£o pode estar no passado
- ‚úÖ M√°ximo 3 meses de anteced√™ncia
- ‚úÖ Apenas hor√°rio comercial (8h-18h)
- ‚úÖ N√£o permite fins de semana
- ‚úÖ Verifica conflitos de hor√°rio
- ‚úÖ Cliente s√≥ pode criar agendamentos para si mesmo

### **Valida√ß√µes de Edi√ß√£o:**

- ‚úÖ N√£o permite editar agendamentos conclu√≠dos ou rejeitados
- ‚úÖ Requer m√≠nimo 24h de anteced√™ncia

### **Valida√ß√µes de Cancelamento:**

- ‚úÖ Apenas agendamentos PENDING podem ser cancelados
- ‚úÖ Requer m√≠nimo 2h de anteced√™ncia

### **Valida√ß√µes de Status:**

- ‚úÖ Apenas profissional pode alterar status
- ‚úÖ Transi√ß√µes de estado controladas
- ‚úÖ COMPLETED apenas se agendamento j√° passou

### **Valida√ß√µes de Permiss√µes:**

- ‚úÖ Acesso aos dados apenas para cliente ou profissional envolvido
- ‚úÖ Estat√≠sticas privadas (apenas do pr√≥prio usu√°rio)

---

## üìä Schemas Zod Implementados

### **CreateAppointmentInputSchema**

```typescript
{
  clientId: string (cuid),
  professionalId: string (cuid),
  serviceId: string (cuid),
  scheduledDate: string (datetime),
  locationType: "AT_LOCATION" | "AT_DOMICILE" | "BOTH",
  clientAddress?: string,
  clientNotes?: string (max 500)
}
```

### **UpdateAppointmentInputSchema**

```typescript
{
  scheduledDate?: string (datetime),
  locationType?: "AT_LOCATION" | "AT_DOMICILE" | "BOTH",
  clientAddress?: string,
  clientNotes?: string (max 500)
}
```

### **GetAppointmentsQuerySchema**

```typescript
{
  page: string (default "1"),
  limit: string (default "10", max 100),
  status?: AppointmentStatus,
  clientId?: string (cuid),
  professionalId?: string (cuid),
  serviceId?: string (cuid),
  dateFrom?: string (datetime),
  dateTo?: string (datetime)
}
```

---

## üß™ Testes Implementados

### **appointments.schema.test.ts**

- ‚úÖ Valida√ß√£o de CreateAppointmentInputSchema
- ‚úÖ Rejei√ß√£o de location types inv√°lidos
- ‚úÖ Rejei√ß√£o de formatos de data inv√°lidos
- ‚úÖ Rejei√ß√£o de notas muito longas (>500 chars)
- ‚úÖ Valida√ß√£o de UpdateAppointmentInputSchema
- ‚úÖ Valida√ß√£o de atualiza√ß√µes parciais
- ‚úÖ Valida√ß√£o de GetAppointmentsQuerySchema
- ‚úÖ Valores padr√£o de page e limit
- ‚úÖ Rejei√ß√£o de page < 1
- ‚úÖ Rejei√ß√£o de limit > 100
- ‚úÖ Valida√ß√£o de AppointmentParamsSchema
- ‚úÖ Valida√ß√£o de enums (AppointmentStatus, ServiceMode)

**Total: 20+ testes unit√°rios**

---

## üìö Documenta√ß√£o Swagger

Todos os endpoints est√£o documentados com:

- ‚úÖ Descri√ß√£o clara da funcionalidade
- ‚úÖ Par√¢metros de entrada (body, query, params)
- ‚úÖ Exemplos de requisi√ß√£o
- ‚úÖ Respostas poss√≠veis (sucesso e erros)
- ‚úÖ C√≥digos HTTP apropriados
- ‚úÖ Tags organizadas ("Appointments")

**Acesso:** `http://localhost:3333/documentation`

---

## üîó Integra√ß√£o com Outros M√≥dulos

### **Depend√™ncias:**

- ‚úÖ **Users**: Valida cliente e profissional
- ‚úÖ **Services**: Valida servi√ßo e obt√©m dura√ß√£o
- ‚úÖ **Categories**: Retorna categoria do servi√ßo
- ‚úÖ **Reviews**: Calcula avalia√ß√£o m√©dia (stats)

### **Rela√ß√µes no Prisma:**

```prisma
model Appointment {
  client       User    @relation("ClientAppointments")
  professional User    @relation("ProfessionalAppointments")
  service      Service @relation
  review       Review? @relation
}
```

---

## üöÄ Como Usar

### **1. Criar Agendamento**

```bash
POST http://localhost:3333/api/v1/appointments
Authorization: Bearer <token>
Content-Type: application/json

{
  "clientId": "clx123",
  "professionalId": "clx456",
  "serviceId": "clx789",
  "scheduledDate": "2024-02-15T14:30:00Z",
  "locationType": "AT_LOCATION",
  "clientNotes": "Primeira consulta"
}
```

### **2. Verificar Disponibilidade**

```bash
GET http://localhost:3333/api/v1/appointments/availability?professionalId=clx456&serviceId=clx789&date=2024-02-15
Authorization: Bearer <token>
```

### **3. Listar Agendamentos**

```bash
GET http://localhost:3333/api/v1/appointments?page=1&limit=10&status=PENDING
Authorization: Bearer <token>
```

### **4. Atualizar Status (Profissional)**

```bash
PATCH http://localhost:3333/api/v1/appointments/clx123/status
Authorization: Bearer <token>
Content-Type: application/json

{
  "status": "ACCEPTED"
}
```

### **5. Estat√≠sticas**

```bash
GET http://localhost:3333/api/v1/appointments/stats?professionalId=clx456
Authorization: Bearer <token>
```

---

## üéØ Pr√≥ximos Passos Sugeridos

### **Funcionalidades Adicionais:**

1. **Notifica√ß√µes**

   - Email/SMS ao criar agendamento
   - Lembrete 24h antes
   - Notifica√ß√£o de mudan√ßa de status

2. **Agendamento Recorrente**

   - Criar agendamentos repetidos (semanal, mensal)
   - Template de agendamento

3. **Lista de Espera**

   - Fila para hor√°rios ocupados
   - Notifica√ß√£o autom√°tica se hor√°rio liberar

4. **Integra√ß√£o com Calend√°rio**

   - Export para Google Calendar, iCal
   - Sincroniza√ß√£o bidirecional

5. **Confirma√ß√£o de Agendamento**

   - Cliente deve confirmar presen√ßa 2h antes
   - Status adicional: CONFIRMED

6. **Pagamentos**
   - Integra√ß√£o com gateway de pagamento
   - Pagamento antecipado ou no local
   - Hist√≥rico financeiro

---

## üìà M√©tricas e Performance

### **Otimiza√ß√µes Implementadas:**

- ‚úÖ √çndices no banco de dados (`professionalId`, `scheduledDate`)
- ‚úÖ Pagina√ß√£o para evitar sobrecarga
- ‚úÖ Select espec√≠fico (n√£o retorna dados desnecess√°rios)
- ‚úÖ Valida√ß√µes em camadas (schema ‚Üí service ‚Üí repository)

### **Considera√ß√µes de Escalabilidade:**

- Cache de disponibilidade (implementar Redis)
- Background jobs para notifica√ß√µes (implementar Bull/BullMQ)
- Otimiza√ß√£o de queries complexas (usar aggregations)

---

## ‚úÖ Resumo da Implementa√ß√£o

| Item            | Status         |
| --------------- | -------------- |
| **Schemas Zod** | ‚úÖ Completo    |
| **Repository**  | ‚úÖ Completo    |
| **Service**     | ‚úÖ Completo    |
| **Controller**  | ‚úÖ Completo    |
| **Routes**      | ‚úÖ Completo    |
| **Testes**      | ‚úÖ 20+ testes  |
| **Swagger**     | ‚úÖ Documentado |
| **Integra√ß√£o**  | ‚úÖ Registrado  |

**Total de Arquivos:** 7  
**Total de Linhas:** ~2.800  
**Total de Endpoints:** 11

---

## üéâ Conclus√£o

O m√≥dulo de **Agendamentos** est√° completamente implementado e pronto para uso!

**Principais destaques:**

- ‚úÖ Arquitetura limpa e escal√°vel
- ‚úÖ Valida√ß√µes robustas de regras de neg√≥cio
- ‚úÖ Documenta√ß√£o Swagger completa
- ‚úÖ Testes unit√°rios
- ‚úÖ Seguindo padr√£o estabelecido (igual a offered-services)
- ‚úÖ Pronto para integra√ß√£o com frontend

**Pronto para prosseguir com o pr√≥ximo m√≥dulo!** üöÄ
