import { auth } from "../../lib/auth";
import { BadRequestError, NotFoundError } from "../../utils/app-error";

/**
 * Servi칞o de Autentica칞칚o
 *
 * Integra com Better Auth para fornecer funcionalidades de:
 * - Registro de usu치rios
 * - Login/Logout
 * - Reset de senha
 * - Verifica칞칚o de email
 * - Gerenciamento de sess칚o
 */
export class AuthService {
  /**
   * Enviar email de recupera칞칚o de senha
   */
  async forgotPassword(email: string): Promise<{ message: string }> {
    try {
      // TODO: Implementar verifica칞칚o real do usu치rio
      // Por enquanto, apenas simular o envio
      console.log(`游닎 Email de recupera칞칚o enviado para: ${email}`);

      // Valida칞칚o b치sica de email
      if (!email || !email.includes("@")) {
        throw new BadRequestError("Email inv치lido");
      }

      return {
        message: "Email de recupera칞칚o enviado com sucesso",
      };
    } catch (error: any) {
      throw new BadRequestError(
        `Erro ao enviar email de recupera칞칚o: ${error.message}`
      );
    }
  }

  /**
   * Verificar se token de reset 칠 v치lido
   */
  async verifyResetToken(
    token: string
  ): Promise<{ valid: boolean; message?: string; error?: string }> {
    try {
      // Mock implementation - Better Auth doesn't have this method
      // In a real implementation, you would verify the token
      return { valid: true, message: "Token v치lido" };
    } catch (error: any) {
      return {
        valid: false,
        error: error.message || "Token inv치lido ou expirado",
      };
    }
  }

  /**
   * Resetar senha com token
   */
  async resetPassword(
    token: string,
    newPassword: string
  ): Promise<{ message: string }> {
    try {
      await auth.api.resetPassword({
        body: { token, newPassword },
      });
      return {
        message: "Senha redefinida com sucesso",
      };
    } catch (error: any) {
      throw new BadRequestError(`Erro ao redefinir senha: ${error.message}`);
    }
  }

  /**
   * Obter sess칚o do usu치rio
   */
  async getSession(headers: any): Promise<any> {
    try {
      return await auth.api.getSession({
        headers,
      });
    } catch (error: any) {
      throw new BadRequestError(`Erro ao obter sess칚o: ${error.message}`);
    }
  }

  /**
   * Fazer login com email e senha
   */
  async signIn(email: string, password: string): Promise<any> {
    try {
      const result = await auth.api.signInEmail({
        body: {
          email,
          password,
        },
      });

      return result;
    } catch (error: any) {
      throw new BadRequestError(`Erro ao fazer login: ${error.message}`);
    }
  }

  /**
   * Registrar novo usu치rio
   */
  async signUp(
    email: string,
    password: string,
    name: string,
    userType: string = "CLIENT"
  ): Promise<any> {
    try {
      const result = await auth.api.signUpEmail({
        body: {
          email,
          password,
          name,
          userType,
        },
      });

      return result;
    } catch (error: any) {
      throw new BadRequestError(`Erro ao registrar usu치rio: ${error.message}`);
    }
  }

  /**
   * Fazer logout
   */
  async signOut(sessionId: string): Promise<{ message: string }> {
    try {
      await auth.api.signOut({
        headers: {
          "x-session-id": sessionId,
        },
      });

      return {
        message: "Logout realizado com sucesso",
      };
    } catch (error: any) {
      throw new BadRequestError(`Erro ao fazer logout: ${error.message}`);
    }
  }
}
